name: CI/CD Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2️⃣ Set up Terraform
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.8.5

      # 3️⃣ Get EC2 public IP from Terraform
      - name: Get EC2 public IP
        run: |
          cd monitoring-project/infra
          terraform init -input=false
          IP=$(terraform output -raw instance_public_ip 2>/dev/null)
          IP=$(echo $IP | tr -d '\n' | tr -d '\r')
          if [[ -z "$IP" ]]; then
            echo "❌ No se pudo obtener la IP de EC2"
            exit 1
          fi
          echo "✅ EC2 IP: $IP"
          # Guardar en GITHUB_ENV para que los siguientes steps la usen
          echo "EC2_IP=$IP" >> $GITHUB_ENV

      # 4️⃣ Debug EC2 IP (opcional, útil para confirmar)
      - name: Debug EC2 IP
        run: echo "EC2_IP=$EC2_IP"

      # 5️⃣ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13.7'

      # 6️⃣ Generate index.html
      - name: Generate index.html
        working-directory: monitoring-project/docker/nginx
        run: python generate_index.py

      # 7️⃣ Log in DockerHub
      - name: Log in DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      # 8️⃣ Build & push NGINX
      - name: Build & push NGINX
        working-directory: monitoring-project/docker/nginx
        run: |
          IMAGE_NAME=${{ env.DOCKERHUB_USERNAME }}/custom-nginx
          docker build -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:latest

      # 9️⃣ Build & push Flask app
      - name: Build & push Flask app
        working-directory: monitoring-project/app
        run: |
          IMAGE_NAME=${{ env.DOCKERHUB_USERNAME }}/flask-app
          docker build -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:latest

      - name: Retrieve SSH key from SSM
        id: ssmkey
        run: |
         PRIVATE_KEY=$(aws ssm get-parameter \
          --name "/ssh/monitoring-project" \
          --with-decryption \
          --query "Parameter.Value" \
          --output text)
         echo "PRIVATE_KEY<<EOF" >> $GITHUB_ENV
         echo "$PRIVATE_KEY" >> $GITHUB_ENV
         echo "EOF" >> $GITHUB_ENV

      - name: Deploy stack on EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ env.EC2_IP }}
          username: ec2-user
          key: ${{ env.PRIVATE_KEY }}
          script: |
            cd /opt/monitoring/monitoring-project
            git pull origin main
            docker-compose pull
            docker-compose up -d --remove-orphans

